<h1>Checkout</h1>

<div class="row justify-content-center">
  <div class="col-md-10">
    <!-- Order Summary Card -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Order Summary</h5>
        <table class="table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <% @cart.cart_items.each do |item| %>
              <tr>
                <td><%= item.product.name %></td>
                <td><%= item.quantity %></td>
                <td>$<%= number_with_precision(item.product.current_price, precision: 2) %></td>
                <td>$<%= number_with_precision(item.total_price, precision: 2) %></td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
              <td><strong>$<%= number_with_precision(@cart.subtotal, precision: 2) %></strong></td>
            </tr>
          </tfoot>
        </table>

        <!-- Tax Calculation Display -->
        <div id="tax-calculation" class="mt-3">
          <p class="text-muted">Select an address below to see tax calculation and total</p>
        </div>
      </div>
    </div>

    <!-- Shipping Address Card -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Shipping Address</h5>

        <% if @addresses.any? %>
          <%= form_with url: orders_path, method: :post, local: true do |f| %>
            <div class="mb-3">
              <%= f.label :address_id, "Select Address", class: "form-label" %>
              <%= f.collection_radio_buttons :address_id, @addresses, :id, :full_address, { required: true } do |b| %>
                <div class="form-check mb-2">
                  <%= b.radio_button class: "form-check-input" %>
                  <%= b.label class: "form-check-label" do %>
                    <%= b.object.street %>, <%= b.object.city %>, <%= b.object.province.name %> <%= b.object.postal_code %>
                  <% end %>
                </div>
              <% end %>
            </div>

            <div class="mb-3">
              <%= link_to "Add New Address", new_address_path, class: "btn btn-sm btn-secondary" %>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4">
              <%= link_to "Back to Cart", cart_path, class: "btn btn-secondary" %>
              <%= f.submit "Place Order", class: "btn btn-primary btn-lg" %>
            </div>
          <% end %>
        <% else %>
          <div class="alert alert-warning">
            You need to add an address before checking out.
            <%= link_to "Add Address", new_address_path, class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  const subtotal = <%= @cart.subtotal %>;

  const provinceTaxes = {
    <% Province.all.each do |province| %>
      <%= province.id %>: {
        gst: <%= province.gst_rate %>,
        pst: <%= province.pst_rate %>,
        hst: <%= province.hst_rate %>,
        name: '<%= province.name %>'
      },
    <% end %>
  };

  const addresses = <%= raw @addresses.map { |a| { id: a.id, province_id: a.province_id } }.to_json %>;

  function calculateTax(addressId) {
    const taxDiv = document.getElementById('tax-calculation');
    const selectedAddress = addresses.find(a => a.id === parseInt(addressId));
    if (!selectedAddress) return;

    const provinceId = selectedAddress.province_id;
    const taxes = provinceTaxes[provinceId];
    if (!taxes) return;

    const gst = subtotal * (taxes.gst / 100);
    const pst = subtotal * (taxes.pst / 100);
    const hst = subtotal * (taxes.hst / 100);
    const totalTax = gst + pst + hst;
    const total = subtotal + totalTax;

    let taxHTML = '<div class="border-top pt-3">';

    if (taxes.gst > 0) {
      taxHTML += `<div class="d-flex justify-content-between"><span>GST (${taxes.gst}%):</span><span>$${gst.toFixed(2)}</span></div>`;
    }
    if (taxes.pst > 0) {
      taxHTML += `<div class="d-flex justify-content-between"><span>PST (${taxes.pst}%):</span><span>$${pst.toFixed(2)}</span></div>`;
    }
    if (taxes.hst > 0) {
      taxHTML += `<div class="d-flex justify-content-between"><span>HST (${taxes.hst}%):</span><span>$${hst.toFixed(2)}</span></div>`;
    }

    taxHTML += `
      <hr>
      <div class="d-flex justify-content-between">
        <h5>Order Total:</h5>
        <h5><strong>$${total.toFixed(2)}</strong></h5>
      </div>
    </div>`;

    taxDiv.innerHTML = taxHTML;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const addressRadios = document.querySelectorAll('input[name="address_id"]');

    addressRadios.forEach((radio, index) => {
      radio.addEventListener('change', function() {
        calculateTax(this.value);
      });

      // Select and calculate for first address
      if (index === 0) {
        radio.checked = true;
        // Call directly with a slight delay
        setTimeout(() => calculateTax(radio.value), 50);
      }
    });
  });
</script>
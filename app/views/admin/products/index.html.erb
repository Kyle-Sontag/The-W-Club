<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Products</h1>
  <%= link_to "New Product", new_admin_product_path, class: "btn btn-primary" %>
</div>

<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: admin_products_path, method: :get, local: true, class: "row g-3" do |f| %>
      <div class="col-md-4">
        <%= f.label :search, "Search Products", class: "form-label" %>
        <div class="input-group">
          <%= f.text_field :search,
              value: params[:search],
              placeholder: "Search by name...",
              class: "form-control" %>
          <button type="submit" class="btn btn-outline-secondary">
            Search
          </button>
        </div>
      </div>

      <div class="col-md-3">
        <%= f.label :category_id, "Filter by Category", class: "form-label" %>
        <%= f.select :category_id,
            options_for_select(
              [['Sale Items', 'sale']] + Category.all.map { |c| [c.name, c.id] },
              params[:category_id]
            ),
            { prompt: "All Categories" },
            { class: "form-select", onchange: "this.form.submit()" } %>
      </div>

      <div class="col-md-3">
        <%= f.label :sort, "Sort by", class: "form-label" %>
        <%= f.select :sort,
            options_for_select([
              ['Newest First', 'created_at_desc'],
              ['Name (A-Z)', 'name_asc'],
              ['Name (Z-A)', 'name_desc'],
              ['Price (Low to High)', 'price_asc'],
              ['Price (High to Low)', 'price_desc'],
              ['Featured First', 'featured']
            ], params[:sort]),
            {},
            { class: "form-select", onchange: "this.form.submit()" } %>
      </div>

      <div class="col-md-2 d-flex align-items-end">
        <%= link_to "Clear Filters", admin_products_path, class: "btn btn-secondary w-100" %>
      </div>
    <% end %>
  </div>
</div>

<% if params[:search].present? || params[:category_id].present? || params[:sort].present? %>
  <div class="alert alert-info">
    Showing
    <% if params[:search].present? %>
      results for "<strong><%= params[:search] %></strong>"
    <% end %>
    <% if params[:category_id].present? %>
      <% if params[:category_id] == 'sale' %>
        showing <strong>Sale Items</strong>
      <% else %>
        <% category = Category.find_by(id: params[:category_id]) %>
        <% if category %>
          in <strong><%= category.name %></strong>
        <% end %>
      <% end %>
    <% end %>
    <% if params[:sort].present? %>
      sorted by <strong><%= params[:sort].humanize %></strong>
    <% end %>
  </div>
<% end %>

<div class="table-responsive">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Image</th>
        <th>Name</th>
        <th>Category</th>
        <th>Price</th>
        <th>Sale Price</th>
        <th>Featured</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @products.each do |product| %>
        <tr id="product-<%= product.id %>">
          <td>
            <% if product.image.attached? %>
              <%= image_tag product.image, size: "50x50" %>
            <% else %>
              <span class="text-muted">No image</span>
            <% end %>
          </td>
          <td><%= product.name %></td>
          <td><%= product.category.name %></td>
          <td>$<%= number_with_precision(product.price, precision: 2) %></td>
          <td>
            <% if product.sale_price %>
              $<%= number_with_precision(product.sale_price, precision: 2) %>
            <% else %>
              -
            <% end %>
          </td>
          <td>
            <% if product.featured %>
              <span class="badge bg-success">Yes</span>
            <% else %>
              <span class="badge bg-secondary">No</span>
            <% end %>
          </td>
          <td>
            <%= link_to "Edit", edit_admin_product_path(product, search: params[:search], category_id: params[:category_id], sort: params[:sort], page: params[:page], anchor: "product-#{product.id}"), class: "btn btn-sm btn-warning" %>
            <%= button_to "Delete", admin_product_path(product), method: :delete,
                class: "btn btn-sm btn-danger",
                data: { confirm: "Are you sure?" } %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<div class="d-flex justify-content-center my-4">
  <%= paginate @products, params: { search: params[:search], category_id: params[:category_id], sort: params[:sort] } %>
</div>

<p class="text-muted">
  Showing <%= @products.count %> of <%= Product.count %> total products
  <% if params[:search].present? %>
    matching "<%= params[:search] %>"
  <% end %>
  <% if params[:category_id].present? && params[:category_id] != 'sale' %>
    <% category = Category.find_by(id: params[:category_id]) %>
    <% if category %>
      in <%= category.name %>
    <% end %>
  <% end %>
</p>